{% extends 'base.html' %}
{% block title %}Audio Pi Control{% endblock %}
{% block content %}
<h2>Audio Pi Websteuerung</h2>

<section id="status">
    <h3>Status</h3>
    {% if status.get('hifiberry_detected') is sameas false %}
    <div class="warning" style="color:#b30000;font-weight:bold;">
        HiFiBerry DAC nicht erkannt – interner Audio-Ausgang aktiv.
    </div>
    {% endif %}
    <ul>
        <li>Aktuell: {{ 'Wiedergabe läuft' if status['playing'] else 'Wiedergabe gestoppt' }}</li>
        <li>Bluetooth: {{ status['bluetooth_status'] }}</li>
        <li>WLAN: {{ status['wlan_status'] }}</li>
        <li>Endstufe: {{ status['amplifier_status'] }}</li>
        <li>Relais-Umkehr: {{ 'Ja' if status['relay_invert'] else 'Nein' }}</li>
        <li>Lautstärke: {{ status['current_volume'] }}</li>
        <li>Audio-Sink: {{ status['current_sink'] }}</li>
        <li>Time: {{ status['current_time'] }}</li>
        <li>
            RTC:
            {% if status['rtc_available'] %}
                Verfügbar (Adresse {{ '0x%02X'|format(status['rtc_address']) }})
            {% else %}
                Nicht verfügbar
            {% endif %}
        </li>
    </ul>
    {% if not status['rtc_available'] %}
    <div class="alert alert-warning rtc-warning" style="background-color:#fff3cd;padding:1rem;border:1px solid #ffeeba;border-radius:0.5rem;color:#856404;margin-top:1rem;">
        <strong>Warnung:</strong> Keine RTC erkannt. Die Systemzeit läuft ohne Hardware-Uhr weiter; bitte Verkabelung und I²C-Konfiguration prüfen.
    </div>
    {% endif %}
</section>

<section id="playback">
    <h3>Playback Steuerung</h3>
    <form action="{{ url_for('set_volume') }}" method="POST" style="display:inline;">
        <input type="number" min="0" max="100" name="volume" placeholder="Lautstärke (%)">
        <button type="submit" class="btn">Setzen</button>
    </form>
    <form action="{{ url_for('activate_amp') }}" method="POST" style="display:inline;">
        <button type="submit" class="btn">Endstufe an</button>
    </form>
    <form action="{{ url_for('deactivate_amp') }}" method="POST" style="display:inline;">
        <button type="submit" class="btn">Endstufe aus</button>
    </form>
    <form action="{{ url_for('set_relay_invert') }}" method="POST" style="display:inline;">
        <label>
            <input type="checkbox" name="invert" value="1" {% if status['relay_invert'] %}checked{% endif %}>
            Relay umkehren
        </label>
        <button type="submit" class="btn">Speichern</button>
    </form>
    <form action="{{ url_for('toggle_pause') }}" method="POST" style="display:inline;">
        <button type="submit" class="btn">Pause/Resume</button>
    </form>
    <form action="{{ url_for('stop_playback') }}" method="POST" style="display:inline;">
        <button type="submit" class="btn">Stopp</button>
    </form>
</section>

<section id="files">
    <h3>Datei-Upload</h3>
    <form action="{{ url_for('upload') }}" method="POST" enctype="multipart/form-data">
        <input type="file" name="file" required>
        <button type="submit" class="btn">Upload</button>
    </form>

    <h3>Audio-Dateien</h3>
    <ul>
        {% for file in files %}
        <li>
            {{ file.filename }}
            {% if file.duration_seconds is not none %}
                ({{ '%.2f' % file.duration_seconds }}&nbsp;s)
            {% else %}
                (Dauer unbekannt)
            {% endif %}
            <a href="{{ url_for('play_now', item_type='file', item_id=file.id) }}">Play</a>
            <form action="{{ url_for('delete', file_id=file.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn">Löschen</button>
            </form>
        </li>
        {% endfor %}
    </ul>
</section>

<section id="playlists">
    <h3>Playlists</h3>
    <form action="{{ url_for('create_playlist') }}" method="POST">
        <input type="text" name="name" placeholder="Playlist-Name" required>
        <button type="submit" class="btn">Erstellen</button>
    </form>
    <ul>
        {% for playlist in playlists %}
        <li>
            {{ playlist.name }}
            <a href="{{ url_for('play_now', item_type='playlist', item_id=playlist.id) }}">Play</a>
            <form action="{{ url_for('delete_playlist', playlist_id=playlist.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn">Löschen</button>
            </form>
            <form action="{{ url_for('add_to_playlist') }}" method="POST" style="display:inline;">
                <select name="file_id">
                    {% for file in files %}
                    <option value="{{ file.id }}">{{ file.filename }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="playlist_id" value="{{ playlist.id }}">
                <button type="submit" class="btn">Hinzufügen</button>
            </form>
        </li>
        {% endfor %}
    </ul>
</section>

<section id="schedules">
    <h3>Zeitpläne</h3>
    <form action="{{ url_for('add_schedule') }}" method="POST">
        <select name="item_type" id="item-type">
            <option value="file">Datei</option>
            <option value="playlist">Playlist</option>
        </select>
        <select name="item_id" id="item-select"></select>
        <input type="datetime-local" name="time" required>
        <select name="repeat" id="repeat-select">
            <option value="daily">Täglich</option>
            <option value="monthly">Monatlich</option>
            <option value="once">Nur einmal</option>
        </select>
        <div id="date-range-fields" style="display:none;">
            <label>
                Startdatum
                <input type="date" name="start_date">
            </label>
            <label>
                Enddatum (optional)
                <input type="date" name="end_date">
            </label>
        </div>
        <input type="number" name="delay" value="5" min="0" max="60" style="width:50px;"> Sek. Verzögerung
        <button type="submit" class="btn">Hinzufügen</button>
    </form>
    <p class="hint">
        Hinweis: Überlappende Zeitpläne werden automatisch verhindert. Bei einem Konflikt erscheint eine Fehlermeldung.
    </p>
    <ul>
        {% for schedule in schedules %}
        <li>
            {{ schedule.name or 'Unbekanntes Element' }} ({{ schedule.item_type }}) - {{ schedule.time }} ({{ schedule.repeat }}) +{{ schedule.delay }}s
            {% if schedule.start_date or schedule.end_date %}
                [
                {{ schedule.start_date or 'ab sofort' }}{% if schedule.end_date %} – {{ schedule.end_date }}{% endif %}
                ]
            {% endif %}
            {% if schedule.executed and schedule.repeat == 'once' %}- ausgeführt{% endif %}
            <form action="{{ url_for('delete_schedule', sch_id=schedule.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn">Entfernen</button>
            </form>
        </li>
        {% endfor %}
    </ul>

    <script>
    const audioFiles = {{ files | tojson }};
    const playlists = {{ playlists | tojson }};
    const itemSelect = document.getElementById('item-select');
    const typeSelect = document.getElementById('item-type');
    const repeatSelect = document.getElementById('repeat-select');
    const dateRangeFields = document.getElementById('date-range-fields');
    const startDateInput = document.querySelector('input[name="start_date"]');
    const endDateInput = document.querySelector('input[name="end_date"]');
    const timeInput = document.querySelector('input[name="time"]');
    function populate() {
        const items = typeSelect.value === 'playlist' ? playlists : audioFiles;
        const label = typeSelect.value === 'playlist' ? 'Playlist' : 'Datei';
        itemSelect.innerHTML = `<option value="">-- ${label} wählen --</option>`;
        for (const item of items) {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.textContent = item.name || item.filename;
            itemSelect.appendChild(opt);
        }
    }
    function updateDateRangeVisibility() {
        if (!repeatSelect) {
            return;
        }
        const show = repeatSelect.value !== 'once';
        dateRangeFields.style.display = show ? 'block' : 'none';
        if (show && timeInput && startDateInput && !startDateInput.value && timeInput.value) {
            const [datePart] = timeInput.value.split('T');
            if (datePart) {
                startDateInput.value = datePart;
            }
        }
        if (!show) {
            if (startDateInput) startDateInput.value = '';
            if (endDateInput) endDateInput.value = '';
        }
    }
    function syncStartDateWithTime() {
        if (!timeInput || !startDateInput) {
            return;
        }
        const [datePart] = timeInput.value.split('T');
        if (datePart && !startDateInput.value) {
            startDateInput.value = datePart;
        }
    }
    typeSelect.addEventListener('change', populate);
    if (repeatSelect) {
        repeatSelect.addEventListener('change', updateDateRangeVisibility);
    }
    if (timeInput) {
        timeInput.addEventListener('change', () => {
            syncStartDateWithTime();
            if (endDateInput && endDateInput.value && startDateInput && startDateInput.value && endDateInput.value < startDateInput.value) {
                endDateInput.value = startDateInput.value;
            }
        });
    }
    populate();
    updateDateRangeVisibility();
    </script>
</section>

<section id="system">
    <h3>System</h3>
    <form action="{{ url_for('update') }}" method="POST">
        <button type="submit" class="btn">Update</button>
    </form>
    <form action="{{ url_for('bluetooth_on') }}" method="POST" style="display:inline;">
        <button type="submit" class="btn">Bluetooth an</button>
    </form>
    <form action="{{ url_for('bluetooth_off') }}" method="POST" style="display:inline;">
        <button type="submit" class="btn">Bluetooth aus</button>
    </form>
</section>

{% endblock %}
