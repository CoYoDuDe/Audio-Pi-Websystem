{% extends 'base.html' %}
{% block title %}Audio Pi Control{% endblock %}
{% block page_heading %}Audio Pi Websteuerung{% endblock %}
{% block flashes %}{% endblock %}
{% block content %}
{% set files_all = files_all | default([], true) %}
{% set playlists_all = playlists_all | default([], true) %}
{% set flashed_messages = get_flashed_messages(with_categories=true) %}
{% set flash_groups = namespace(general=[], network=[]) %}
{% for category, message in flashed_messages %}
    {% if category == 'network_settings' %}
        {% set flash_groups.network = flash_groups.network + [message] %}
    {% else %}
        {% set flash_groups.general = flash_groups.general + [message] %}
    {% endif %}
{% endfor %}

<div class="dashboard-group" id="group-status">
    <h2 class="dashboard-group-title">Systemstatus</h2>
    {% if flash_groups.general %}
    <ul class="flashes">
        {% for message in flash_groups.general %}
        <li>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}

    <section id="status" class="dashboard-section dashboard-section--status">
        <article class="dashboard-card stack-md">
            <h3>Status</h3>
    {% set dac_label = status.get('dac_sink_label') or 'Konfigurierter DAC' %}
    {% set target_sink = status.get('target_dac_sink') or status.get('dac_sink_hint') %}
    {% if status.get('dac_sink_detected') is sameas false %}
    <div class="warning text-warning">
        {{ dac_label }} nicht erkannt – interner Audio-Ausgang aktiv.
        {% if target_sink %}
        <br><small>Geprüfter Sink: {{ target_sink }}</small>
        {% endif %}
    </div>
    {% endif %}
    <ul>
        <li>Aktuell: {{ 'Wiedergabe läuft' if status['playing'] else 'Wiedergabe gestoppt' }}</li>
        <li>Bluetooth: {{ status['bluetooth_status'] }}</li>
        <li>WLAN: {{ status['wlan_status'] }}</li>
        <li>Endstufe: {{ status['amplifier_status'] }}</li>
        <li>Relais-Umkehr: {{ 'Ja' if status['relay_invert'] else 'Nein' }}</li>
        <li>Lautstärke: {{ status['current_volume'] }}</li>
        <li>Audio-Sink: {{ status['current_sink'] }}</li>
        <li>Time: {{ status['current_time'] }}</li>
        <li>
            RTC:
            {{ status['rtc_module_label'] }}
            {% if status['rtc_available'] %}
                – verfügbar
                {% if status['rtc_address'] is not none %}
                    (Adresse {{ '0x%02X'|format(status['rtc_address']) }})
                {% endif %}
            {% else %}
                – Nicht verfügbar
            {% endif %}
            {% if status['rtc_candidates_display'] %}
                <br><small>Durchsuchte Adressen: {{ status['rtc_candidates_display'] }}</small>
            {% endif %}
        </li>
    </ul>
    {% if not status['rtc_available'] %}
    <div class="alert alert-warning rtc-warning">
        <strong>Warnung:</strong> Keine RTC erkannt. Die Systemzeit läuft ohne Hardware-Uhr weiter; bitte Verkabelung und I²C-Konfiguration prüfen.
    </div>
    {% endif %}
        </article>
    </section>
</div>

{% set network_mode = (network_settings.mode | default('dhcp')) %}
{% set manual_mode = (network_mode == 'manual') %}
{% set manual_hidden_class = '' if manual_mode else 'is-hidden' %}

<div class="dashboard-group" id="group-network">
    <h2 class="dashboard-group-title">Netzwerk</h2>
    <section id="network-settings" class="dashboard-section dashboard-section--network section-card">
        <article class="dashboard-card stack-lg">
            <h3>Netzwerkeinstellungen</h3>
            <form
                id="network-settings-form"
                action="{{ url_for('save_network_settings') }}"
                method="POST"
                class="network-settings-form form-card stack-md max-w-36"
            >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <fieldset class="fieldset-inline">
            <legend class="legend-strong">IPv4-Konfiguration</legend>
            <label class="choice-inline">
                <input type="radio" name="mode" value="dhcp" {% if not manual_mode %}checked{% endif %}>
                DHCP (automatisch beziehen)
            </label>
            <label class="choice-inline">
                <input type="radio" name="mode" value="manual" {% if manual_mode %}checked{% endif %}>
                Manuell (statische IPv4)
            </label>
        </fieldset>
        <div class="network-field-grid form-grid">
            <label
                for="ipv4-address"
                data-manual-field="ipv4"
                class="form-field manual-only {{ manual_hidden_class }}"
            >
                IPv4-Adresse
                <input
                    type="text"
                    id="ipv4-address"
                    name="ipv4_address"
                    placeholder="z. B. 192.168.0.10"
                    value="{{ network_settings.ipv4_address }}"
                    data-manual-input="ipv4"
                    data-required-when-manual="true"
                >
            </label>
            <label
                for="ipv4-prefix"
                data-manual-field="ipv4"
                class="form-field manual-only {{ manual_hidden_class }}"
            >
                Präfix (CIDR)
                <input
                    type="number"
                    id="ipv4-prefix"
                    name="ipv4_prefix"
                    min="0"
                    max="32"
                    placeholder="z. B. 24"
                    value="{{ network_settings.ipv4_prefix }}"
                    data-manual-input="ipv4"
                    data-required-when-manual="true"
                >
            </label>
            <label
                for="ipv4-gateway"
                data-manual-field="ipv4"
                class="form-field manual-only {{ manual_hidden_class }}"
            >
                Gateway
                <input
                    type="text"
                    id="ipv4-gateway"
                    name="ipv4_gateway"
                    placeholder="z. B. 192.168.0.1"
                    value="{{ network_settings.ipv4_gateway }}"
                    data-manual-input="ipv4"
                    data-required-when-manual="true"
                >
            </label>
            <label
                for="dns-servers"
                data-manual-field="ipv4"
                class="form-field manual-only {{ manual_hidden_class }}"
            >
                DNS-Server
                <input
                    type="text"
                    id="dns-servers"
                    name="dns_servers"
                    placeholder="z. B. 1.1.1.1, 8.8.8.8"
                    value="{{ network_settings.dns_servers }}"
                    data-manual-input="ipv4"
                    data-required-when-manual="true"
                >
            </label>
        </div>
        <div class="network-identity-group form-section-divider form-grid">
            <label for="hostname" class="form-field">
                Hostname
                <input
                    type="text"
                    id="hostname"
                    name="hostname"
                    placeholder="z. B. audio-pi"
                    value="{{ network_settings.hostname }}"
                >
            </label>
            <label for="local-domain" class="form-field">
                Lokale Domain (optional)
                <input
                    type="text"
                    id="local-domain"
                    name="local_domain"
                    placeholder="z. B. lan"
                    value="{{ network_settings.local_domain }}"
                >
            </label>
        </div>
        <small data-manual-hint class="form-helper manual-only {{ manual_hidden_class }}">IPv4-Adresse, Präfix, Gateway und DNS-Server werden nur benötigt, wenn „Manuell (statische IPv4)“ aktiv ist.</small>
        <button type="submit" class="btn align-self-start">Speichern</button>
            </form>
            {% if flash_groups.network %}
            <ul class="flashes mt-sm">
                {% for message in flash_groups.network %}
                <li>{{ message }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </article>
        <article class="dashboard-card stack-md">
            <h3>WLAN-Scan</h3>
            <p class="hint">
                Starte einen neuen Scan nach verfügbaren Netzwerken. Die Ergebnisse werden auf einer separaten
                Seite angezeigt und können zum Verbinden mit einem WLAN genutzt werden.
            </p>
            <form action="{{ url_for('wlan_scan') }}" method="post" class="form-card stack-sm max-w-20">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn align-self-start">Scan starten</button>
            </form>
        </article>
    </section>
</div>

<div class="dashboard-group" id="group-audio">
    <h2 class="dashboard-group-title">Audio &amp; Wiedergabe</h2>
    <section id="amplifier-settings" class="dashboard-section dashboard-section--audio section-card">
        <article class="dashboard-card stack-md">
            <h3>Verstärker-GPIO</h3>
            {% set amplifier_source = status.get('amplifier_gpio_pin_source', 'default') %}
            {% set amplifier_source_labels = {'default': 'Standard', 'settings': 'Benutzerdefiniert'} %}
            <form action="{{ url_for('save_amplifier_pin') }}" method="POST" class="amplifier-pin-form form-card stack-sm max-w-20">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label for="amplifier-gpio-pin" class="form-field">
                    GPIO-Pin für die Endstufe
                    <input
                        type="number"
                        id="amplifier-gpio-pin"
                        name="amplifier_gpio_pin"
                        min="0"
                        required
                        value="{{ status.get('amplifier_gpio_pin', status.get('amplifier_gpio_pin_default', 17)) }}"
                    >
                </label>
                <small class="form-helper">
                    Aktuell: GPIO{{ status.get('amplifier_gpio_pin', status.get('amplifier_gpio_pin_default', 17)) }}
                    ({{ amplifier_source_labels.get(amplifier_source, amplifier_source) }}).
                    Standard ist GPIO{{ status.get('amplifier_gpio_pin_default', 17) }}.
                    Für den HiFiBerry&nbsp;Amp2 kann alternativ GPIO18 genutzt werden.
                </small>
                <small class="form-helper">
                    Hinweis: Die I²C-Leitungen GPIO2&nbsp;(SDA1) und GPIO3&nbsp;(SCL1) bleiben unbelegt – z.&nbsp;B. für RTC-Module oder Sensoren.
                    Weitere freie GPIOs können für Taster oder Relais vergeben werden, solange sie nicht mit diesem Verstärker-Pin kollidieren.
                </small>
                <button type="submit" class="btn align-self-start">Speichern</button>
            </form>
        </article>
    </section>

    <section id="audio-sink-settings" class="dashboard-section dashboard-section--audio section-card">
        <article class="dashboard-card stack-md">
            <h3>Audio-Sink Konfiguration</h3>
            <form action="{{ url_for('save_dac_sink') }}" method="POST" class="dac-sink-form form-card stack-sm max-w-32">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label for="dac-sink-name" class="form-field">
                    Bevorzugter PulseAudio-Sink
                    <input
                        type="text"
                        id="dac-sink-name"
                        name="dac_sink_name"
                        value="{{ status['configured_dac_sink'] or '' }}"
                        placeholder="z.B. alsa_output.platform-soc_107c000000_sound.stereo-fallback"
                    >
                </label>
                <small class="form-helper">
                    Leer lassen, um den Standardsink
                    <code>{{ status['default_dac_sink'] }}</code>
                    zu verwenden.
                    Aktuell aktiv: <code>{{ status['current_sink'] }}</code>
                </small>
                <button type="submit" class="btn align-self-start">Speichern</button>
            </form>
        </article>
    </section>

    <section id="audio-normalization-settings" class="dashboard-section dashboard-section--audio section-card">
        <article class="dashboard-card stack-md">
            <h3>Audio-Normalisierung</h3>
            {% set stored_headroom = status.get('normalization_headroom_stored') %}
            {% set env_headroom = status.get('normalization_headroom_env') %}
            {% set effective_headroom = '%.2f' % status.get('normalization_headroom', default_headroom) %}
            {% set input_headroom = stored_headroom if stored_headroom else (env_headroom if env_headroom else effective_headroom) %}
            <form action="{{ url_for('save_normalization_headroom') }}" method="POST" class="normalization-form form-card stack-sm max-w-20">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label for="normalization-headroom" class="form-field">
                    Zielpegel (negativ) bzw. Headroom (positiv) für die Normalisierung (dB)
                    <input
                        type="number"
                        id="normalization-headroom"
                        name="normalization_headroom_db"
                        step="0.1"
                        value="{{ input_headroom }}"
                        placeholder="z. B. -3 für Zielpegel oder 3 für Headroom"
                    >
                </label>
                <small class="form-helper">
                    Negative Eingaben werden als gewünschter Zielpegel interpretiert und in den entsprechenden positiven Headroom umgerechnet.
                    Leer lassen, um den Standardwert von {{ '%.2f' % default_headroom }}&nbsp;dB zu verwenden.
                    Wirksam genutzter Headroom: {{ '%.2f' % status.get('normalization_headroom', default_headroom) }}&nbsp;dB.
                </small>
                {% if env_headroom %}
                <p class="hint mb-none">
                    Hinweis: Die Umgebungsvariable <code>{{ normalization_headroom_env_key }}</code>
                    überschreibt gespeicherte Zielpegel/Headroom-Vorgaben (aktuell {{ env_headroom }}).
                </p>
                {% endif %}
                <button type="submit" class="btn align-self-start">Speichern</button>
            </form>
        </article>
    </section>

    <section id="schedule-default-volume-settings" class="dashboard-section dashboard-section--audio section-card">
        <article class="dashboard-card stack-md">
            <h3>Standard-Lautstärke für Zeitpläne</h3>
            {% set schedule_volume_percent = status.get('schedule_default_volume_percent', schedule_default_volume_fallback) %}
            {% set schedule_volume_source = status.get('schedule_default_volume_source', 'default') %}
            {% set schedule_volume_raw_percent = schedule_default_volume_raw_percent %}
            {% set schedule_volume_raw_db = schedule_default_volume_raw_db %}
            {% set schedule_volume_db_value = schedule_default_volume_db_value %}
            {% set schedule_volume_input = schedule_volume_raw_percent if schedule_volume_raw_percent else (schedule_volume_raw_db if schedule_volume_raw_db else '') %}
            {% set schedule_volume_source_labels = {
                'settings_percent': 'gespeicherter Prozentwert',
                'settings_db': 'gespeicherter dB-Wert',
                'default': 'Voreinstellung'
            } %}
            {% set schedule_volume_source_label = schedule_volume_source_labels.get(schedule_volume_source, schedule_volume_source) %}
            <form action="{{ url_for('save_schedule_default_volume') }}" method="POST" class="schedule-default-volume-form form-card stack-sm max-w-20">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label for="schedule-default-volume" class="form-field">
                    Standard-Lautstärke für neue Zeitpläne (0–100&nbsp;% oder dB)
                    <input
                        type="text"
                        id="schedule-default-volume"
                        name="schedule_default_volume"
                        value="{{ schedule_volume_input }}"
                        placeholder="z. B. 75 oder -6 dB"
                    >
                </label>
                <small class="form-helper">
                    Aktuell wirksam: {{ schedule_volume_percent }}% (Quelle: {{ schedule_volume_source_label }}{% if schedule_volume_db_value is not none %}, {{ '%g' % schedule_volume_db_value }}&nbsp;dB{% endif %}).
                    Feld leer lassen, um den Standardwert von {{ schedule_default_volume_fallback }}% zu verwenden.
                </small>
                {% if schedule_volume_raw_percent %}
                <p class="hint mb-none">Gespeicherter Prozentwert: {{ schedule_volume_raw_percent }}.</p>
                {% elif schedule_volume_raw_db %}
                <p class="hint mb-none">Gespeicherter dB-Wert: {{ schedule_volume_raw_db }}.</p>
                {% endif %}
                <button type="submit" class="btn align-self-start">Speichern</button>
            </form>
        </article>
    </section>

    <section id="hardware-buttons-admin" class="dashboard-section dashboard-section--audio section-card">
        <article class="dashboard-card stack-lg">
            <h3>Hardware-Taster Verwaltung</h3>
            <p class="hint max-w-60ch">
                Konfiguriere hier physische Taster des Raspberry&nbsp;Pi. Die Zuweisungen werden sofort gespeichert
                und der Button-Monitor automatisch neu gestartet. Für die Aktion <strong>PLAY</strong> muss ein Ziel
                (Datei oder Playlist) gewählt werden.
            </p>
            <div class="hardware-button-admin grid-2 gap-xl mt-lg">
                <div class="hardware-button-create form-card stack-md">
                    <h4>Neue Zuordnung</h4>
                    <form action="{{ url_for('create_hardware_button') }}" method="POST" class="hardware-button-form stack-md">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <label class="form-field">
                            GPIO-Pin
                            <input type="number" name="gpio_pin" min="0" required>
                        </label>
                        <label class="form-field">
                            Aktion
                            <select name="action" required>
                                {% for value, label in hardware_button_actions %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <label class="form-field">
                            Ziel (nur für PLAY erforderlich)
                            <select name="item_reference">
                                <option value="">– Keine Auswahl –</option>
                                <optgroup label="Audiodateien">
                                    {% for file in files_all %}
                                    <option value="file:{{ file['id'] }}">{{ file['filename'] }}</option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="Playlists">
                                    {% for playlist in playlists_all %}
                                    <option value="playlist:{{ playlist['id'] }}">{{ playlist['name'] }}</option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                        </label>
                        <label class="form-field">
                            Entprellzeit (ms)
                            <input type="number" name="debounce_ms" min="0" value="{{ default_button_debounce_ms }}">
                        </label>
                        <label class="choice-inline">
                            <input type="checkbox" name="enabled" checked>
                            Aktiviert
                        </label>
                        <button type="submit" class="btn align-self-start">Anlegen</button>
                    </form>
                </div>
                <div class="hardware-button-existing form-card stack-md">
                    <h4>Bestehende Zuordnungen</h4>
                    {% if hardware_buttons %}
                    <div class="hardware-button-list card-list">
                        {% for button in hardware_buttons %}
                        <div class="hardware-button-entry card">
                            <form action="{{ url_for('update_hardware_button', button_id=button['id']) }}" method="POST" class="flex-row flex-wrap gap-lg items-end">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <label class="form-field min-w-10">
                                    GPIO-Pin
                                    <input type="number" name="gpio_pin" min="0" value="{{ button['gpio_pin'] }}" required>
                                </label>
                                <label class="form-field min-w-12">
                                    Aktion
                                    <select name="action" required>
                                        {% for value, label in hardware_button_actions %}
                                        <option value="{{ value }}" {% if button['action'] == value %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </label>
                                <label class="form-field min-w-14">
                                    Ziel (für PLAY)
                                    <select name="item_reference">
                                        <option value="">– Keine Auswahl –</option>
                                        <optgroup label="Audiodateien">
                                            {% for file in files_all %}
                                            <option value="file:{{ file['id'] }}" {% if button['item_reference'] == 'file:' ~ file['id'] %}selected{% endif %}>{{ file['filename'] }}</option>
                                            {% endfor %}
                                        </optgroup>
                                        <optgroup label="Playlists">
                                            {% for playlist in playlists_all %}
                                            <option value="playlist:{{ playlist['id'] }}" {% if button['item_reference'] == 'playlist:' ~ playlist['id'] %}selected{% endif %}>{{ playlist['name'] }}</option>
                                            {% endfor %}
                                        </optgroup>
                                    </select>
                                    {% if button['item_label'] %}
                                    <small>Aktuell: {{ button['item_label'] }}</small>
                                    {% endif %}
                                </label>
                                <label class="form-field min-w-10">
                                    Entprellzeit (ms)
                                    <input type="number" name="debounce_ms" min="0" value="{{ button['debounce_ms'] }}">
                                </label>
                                <label class="choice-inline">
                                    <input type="checkbox" name="enabled" {% if button['enabled'] %}checked{% endif %}>
                                    Aktiviert
                                </label>
                                <div class="inline-actions-tight">
                                    <button type="submit" class="btn">Speichern</button>
                                </div>
                            </form>
                            <form action="{{ url_for('delete_hardware_button', button_id=button['id']) }}" method="POST" class="inline-form align-self-end">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-danger" onclick="return confirm('Zuordnung wirklich löschen?');">Löschen</button>
                            </form>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p>Keine Hardware-Taster konfiguriert.</p>
                    {% endif %}
                </div>
            </div>
        </article>
    </section>

    <section id="playback" class="dashboard-section dashboard-section--audio section-card">
        <article class="dashboard-card stack-md">
            <h3>Playback Steuerung</h3>
            <form action="{{ url_for('set_volume') }}" method="POST" class="inline-actions">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% set raw_volume = status['current_volume'] | default('50', true) %}
                {% set volume_digits = raw_volume | replace('%', '') | replace(' ', '') | trim %}
                {% set volume_initial = volume_digits if volume_digits.isdigit() else '50' %}
                <label class="volume-slider choice-inline">
                    <input
                        type="range"
                        min="0"
                        max="100"
                        name="volume"
                        id="volume-slider"
                        value="{{ volume_initial }}"
                    >
                    <span id="volume-value" class="inline-value">{{ volume_initial }}%</span>
                </label>
                <button type="submit" class="btn">Setzen</button>
            </form>
            <form action="{{ url_for('activate_amp') }}" method="POST" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn">Endstufe an</button>
            </form>
            <form action="{{ url_for('deactivate_amp') }}" method="POST" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn">Endstufe aus</button>
            </form>
            <form action="{{ url_for('set_relay_invert') }}" method="POST" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label class="choice-inline">
                    <input type="checkbox" name="invert" value="1" {% if status['relay_invert'] %}checked{% endif %}>
                    Relay umkehren
                </label>
                <button type="submit" class="btn">Speichern</button>
            </form>
            <form action="{{ url_for('toggle_pause') }}" method="POST" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn">Pause/Resume</button>
            </form>
            <form action="{{ url_for('stop_playback') }}" method="POST" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn">Stopp</button>
            </form>
        </article>
    </section>

    <section id="files" class="dashboard-section dashboard-section--audio">
        <article class="dashboard-card stack-lg">
            <div class="dashboard-subsection stack-sm">
                <h3>Datei-Upload</h3>
                <form action="{{ url_for('upload') }}" method="POST" enctype="multipart/form-data" class="stack-sm file-upload-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <label class="form-field file-upload-label" for="file-upload">
                        <span class="form-label">Datei auswählen</span>
                        <input type="file" id="file-upload" name="file" class="file-upload-input" required>
                    </label>
                    <button type="submit" class="btn">Upload</button>
                </form>
            </div>

            <div class="dashboard-subsection stack-md">
                <h3>Audio-Dateien</h3>
                <div class="pagination-container">
                    <form method="get" class="page-size-form">
                        <input type="hidden" name="file_page" value="1">
                        <input type="hidden" name="schedule_page" value="{{ schedules_page.page }}">
                        <input type="hidden" name="schedule_page_size" value="{{ schedules_page.page_size_value }}">
                        <label>
                            Einträge pro Seite
                            <select name="file_page_size" onchange="this.form.submit()">
                                {% for option in page_size_options %}
                                <option value="{{ option.value }}" {% if option.value == files_page.page_size_value %}selected{% endif %}>{{ option.label }}</option>
                                {% endfor %}
                            </select>
                        </label>
                    </form>
                    <div class="pagination-info" data-target="files">
                        <span>Seite {{ files_page.page }} von {{ files_page.total_pages }}</span>
                        <span>{{ files_total.count }} Dateien gesamt</span>
                    </div>
                </div>
                <ul class="item-list file-list">
                    {% for file in files_page['items'] %}
                    <li class="file-entry" data-file-id="{{ file.id }}">
                        <span class="item-title">{{ file.filename }}</span>
                        {% if file.duration_seconds is not none %}
                            <span class="item-meta">({{ '%.2f' % file.duration_seconds }}&nbsp;s)</span>
                        {% else %}
                            <span class="item-meta">(Dauer unbekannt)</span>
                        {% endif %}
                        <form
                            action="{{ url_for('play_now', item_type='file', item_id=file.id) }}"
                            method="POST"
                            class="inline-form"
                        >
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn">Play</button>
                        </form>
                        <form action="{{ url_for('delete', file_id=file.id) }}" method="POST" class="inline-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn">Löschen</button>
                        </form>
                    </li>
                    {% else %}
                    <li class="empty-state">Keine Dateien vorhanden.</li>
                    {% endfor %}
                </ul>
                <nav class="pagination-nav" aria-label="Dateiliste">
                    {% if files_page.has_previous %}
                    <a
                        class="page-link"
                        href="{{ build_index_url(file_page=files_page.previous_page, file_page_size=files_page.page_size_value, schedule_page=schedules_page.page, schedule_page_size=schedules_page.page_size_value) }}"
                    >&laquo;</a>
                    {% else %}
                    <span class="page-link disabled">&laquo;</span>
                    {% endif %}
                    {% for page_number in files_page.pages %}
                        {% if page_number == files_page.page %}
                        <span class="page-link active">{{ page_number }}</span>
                        {% else %}
                        <a
                            class="page-link"
                            href="{{ build_index_url(file_page=page_number, file_page_size=files_page.page_size_value, schedule_page=schedules_page.page, schedule_page_size=schedules_page.page_size_value) }}"
                        >{{ page_number }}</a>
                        {% endif %}
                    {% endfor %}
                    {% if files_page.has_next %}
                    <a
                        class="page-link"
                        href="{{ build_index_url(file_page=files_page.next_page, file_page_size=files_page.page_size_value, schedule_page=schedules_page.page, schedule_page_size=schedules_page.page_size_value) }}"
                    >&raquo;</a>
                    {% else %}
                    <span class="page-link disabled">&raquo;</span>
                    {% endif %}
                </nav>
            </div>
        </article>
    </section>

    <section id="playlists" class="dashboard-section dashboard-section--audio">
        <article class="dashboard-card stack-md">
            <h3>Playlists</h3>
            <form action="{{ url_for('create_playlist') }}" method="POST" class="inline-actions stack-sm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="text" name="name" placeholder="Playlist-Name" required>
                <button type="submit" class="btn">Erstellen</button>
            </form>
            <ul>
                {% for playlist in playlists %}
                <li>
                    {{ playlist.name }}
                    <form
                        action="{{ url_for('play_now', item_type='playlist', item_id=playlist.id) }}"
                        method="POST"
                        class="inline-form"
                    >
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn">Play</button>
                    </form>
                    <form action="{{ url_for('delete_playlist', playlist_id=playlist.id) }}" method="POST" class="inline-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn">Löschen</button>
                    </form>
                    <form action="{{ url_for('add_to_playlist') }}" method="POST" class="inline-form inline-actions-tight">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <select name="file_id">
                            {% for file in files_all %}
                            <option value="{{ file.id }}">{{ file.filename }}</option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="playlist_id" value="{{ playlist.id }}">
                        <button type="submit" class="btn">Hinzufügen</button>
                    </form>
                </li>
                {% endfor %}
            </ul>
        </article>
    </section>

    <section id="schedules" class="dashboard-section dashboard-section--audio">
        <article class="dashboard-card stack-lg">
            <h3>Zeitpläne</h3>
    {% set has_schedule_files = files_all | length > 0 %}
    {% set has_schedule_playlists = playlists_all | length > 0 %}
    {% if has_schedule_files %}
        {% set schedule_initial_item_type = 'file' %}
        {% set schedule_initial_item_id = files_all[0]['id'] %}
    {% elif has_schedule_playlists %}
        {% set schedule_initial_item_type = 'playlist' %}
        {% set schedule_initial_item_id = playlists_all[0]['id'] %}
    {% else %}
        {% set schedule_initial_item_type = 'file' %}
        {% set schedule_initial_item_id = none %}
    {% endif %}
    <form action="{{ url_for('add_schedule') }}" method="POST" class="stack-sm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% set schedule_defaults = namespace(item_type=None, item_id=None) %}
        {% if files_all %}
            {% set schedule_defaults.item_type = 'file' %}
            {% set schedule_defaults.item_id = files_all[0].id %}
        {% elif playlists_all %}
            {% set schedule_defaults.item_type = 'playlist' %}
            {% set schedule_defaults.item_id = playlists_all[0].id %}
        {% endif %}
        <label for="item-type" class="form-field">
            Elementtyp
            <select name="item_type" id="item-type">
                <option value="file" {% if schedule_initial_item_type == 'file' %}selected{% endif %}>Datei</option>
                <option value="playlist" {% if schedule_initial_item_type == 'playlist' %}selected{% endif %}>Playlist</option>
            </select>
        </label>
        <label for="item-select" class="form-field">
            Element auswählen
            <select
                name="item_id"
                id="item-select"
                data-initial-type="{{ schedule_initial_item_type }}"
            >
                <option
                    value=""
                    data-item-type="file"
                    data-placeholder="true"
                    {% if not has_schedule_files %}data-default="true"{% endif %}
                    {% if schedule_initial_item_type == 'file' and schedule_initial_item_id is none %}selected{% endif %}
                >
                    -- Datei wählen --
                </option>
                {% for file in files_all %}
                <option
                    value="{{ file.id }}"
                    data-item-type="file"
                    {% if loop.first %}data-default="true"{% endif %}
                    {% if schedule_initial_item_type == 'file' and file.id == schedule_initial_item_id %}selected{% endif %}
                >
                    {{ file.filename }}
                </option>
                {% endfor %}
                <option
                    value=""
                    data-item-type="playlist"
                    data-placeholder="true"
                    {% if not has_schedule_playlists %}data-default="true"{% endif %}
                    {% if schedule_initial_item_type == 'playlist' and schedule_initial_item_id is none %}selected{% endif %}
                >
                    -- Playlist wählen --
                </option>
                {% for playlist in playlists_all %}
                <option
                    value="{{ playlist.id }}"
                    data-item-type="playlist"
                    {% if loop.first %}data-default="true"{% endif %}
                    {% if schedule_initial_item_type == 'playlist' and playlist.id == schedule_initial_item_id %}selected{% endif %}
                >
                    {{ playlist.name }}
                </option>
                {% endfor %}
            </select>
        </label>
        <label for="schedule-time" class="form-field">
            Startzeitpunkt
            <input type="datetime-local" name="time" id="schedule-time" required>
        </label>
        <label for="repeat-select" class="form-field">
            Wiederholung
            <select name="repeat" id="repeat-select">
                <option value="daily">Täglich</option>
                <option value="monthly">Monatlich</option>
                <option value="once">Nur einmal</option>
            </select>
        </label>
        <div id="date-range-fields" class="stack-sm is-hidden">
            <label class="form-field">
                Startdatum
                <input type="date" name="start_date">
            </label>
            <label class="form-field">
                Enddatum (optional)
                <input type="date" name="end_date">
            </label>
        </div>
        {% set schedule_volume_initial = schedule_default_volume_percent if schedule_default_volume_percent is not none else schedule_default_volume_fallback %}
        {% set schedule_volume_value = schedule_volume_initial %}
        <label class="schedule-volume choice-inline mt-sm">
            Lautstärke
            <input
                type="range"
                name="volume_percent"
                id="schedule-volume"
                min="0"
                max="100"
                value="{{ schedule_volume_value }}"
            >
            <span id="schedule-volume-value" class="inline-value">{{ schedule_volume_value }}%</span>
        </label>
        <label for="schedule-delay" class="form-field">
            Verzögerung (Sekunden)
            <input
                type="number"
                name="delay"
                id="schedule-delay"
                value="{{ default_schedule_delay }}"
                min="0"
                max="{{ max_schedule_delay_seconds }}"
                class="w-50"
            >
        </label>
        <button type="submit" class="btn">Hinzufügen</button>
    </form>
    <p class="hint">
        Hinweis: Überlappende Zeitpläne werden automatisch verhindert. Bei einem Konflikt erscheint eine Fehlermeldung.
    </p>
    <p class="hint">Maximale Verzögerung: {{ max_schedule_delay_seconds }}&nbsp;Sekunden.</p>
    <div class="pagination-container">
        <form method="get" class="page-size-form">
            <input type="hidden" name="schedule_page" value="1">
            <input type="hidden" name="file_page" value="{{ files_page.page }}">
            <input type="hidden" name="file_page_size" value="{{ files_page.page_size_value }}">
            <label>
                Einträge pro Seite
                <select name="schedule_page_size" onchange="this.form.submit()">
                    {% for option in page_size_options %}
                    <option value="{{ option.value }}" {% if option.value == schedules_page.page_size_value %}selected{% endif %}>{{ option.label }}</option>
                    {% endfor %}
                </select>
            </label>
        </form>
        <div class="pagination-info" data-target="schedules">
            <span>Seite {{ schedules_page.page }} von {{ schedules_page.total_pages }}</span>
            <span>{{ schedules_total.count }} Zeitpläne gesamt</span>
        </div>
    </div>
    <ul class="item-list schedule-list">
        {% for schedule in schedules_page['items'] %}
        <li class="schedule-entry" data-schedule-id="{{ schedule.id }}">
            <span class="item-title">{{ schedule.name or 'Unbekanntes Element' }}</span>
            <span class="item-meta">({{ schedule.item_type }}) – {{ schedule.time_display }} ({{ schedule.repeat }}) +{{ schedule.delay }}s</span>
            <span class="item-meta">Lautstärke {{ schedule.volume_percent }}%</span>
            {% if schedule.start_date or schedule.end_date %}
                <span class="item-meta">
                    [
                    {{ schedule.start_date or 'ab sofort' }}{% if schedule.end_date %} – {{ schedule.end_date }}{% endif %}
                    ]
                </span>
            {% endif %}
            {% if schedule.executed and schedule.repeat == 'once' %}<span class="item-meta">– ausgeführt</span>{% endif %}
            <form action="{{ url_for('delete_schedule', sch_id=schedule.id) }}" method="POST" class="inline-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn">Entfernen</button>
            </form>
        </li>
        {% else %}
        <li class="empty-state">Keine Zeitpläne vorhanden.</li>
        {% endfor %}
    </ul>
    <nav class="pagination-nav" aria-label="Zeitpläne">
        {% if schedules_page.has_previous %}
        <a
            class="page-link"
            href="{{ build_index_url(schedule_page=schedules_page.previous_page, schedule_page_size=schedules_page.page_size_value, file_page=files_page.page, file_page_size=files_page.page_size_value) }}"
        >&laquo;</a>
        {% else %}
        <span class="page-link disabled">&laquo;</span>
        {% endif %}
        {% for page_number in schedules_page.pages %}
            {% if page_number == schedules_page.page %}
            <span class="page-link active">{{ page_number }}</span>
            {% else %}
            <a
                class="page-link"
                href="{{ build_index_url(schedule_page=page_number, schedule_page_size=schedules_page.page_size_value, file_page=files_page.page, file_page_size=files_page.page_size_value) }}"
            >{{ page_number }}</a>
            {% endif %}
        {% endfor %}
        {% if schedules_page.has_next %}
        <a
            class="page-link"
            href="{{ build_index_url(schedule_page=schedules_page.next_page, schedule_page_size=schedules_page.page_size_value, file_page=files_page.page, file_page_size=files_page.page_size_value) }}"
        >&raquo;</a>
        {% else %}
        <span class="page-link disabled">&raquo;</span>
        {% endif %}
    </nav>

    <script>
    const audioFiles = {{ files_all | tojson }};
    const playlists = {{ playlists_all | tojson }};
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const itemSelect = document.getElementById('item-select');
        const typeSelect = document.getElementById('item-type');
        const repeatSelect = document.getElementById('repeat-select');
        const dateRangeFields = document.getElementById('date-range-fields');
        const startDateInput = document.querySelector('input[name="start_date"]');
        const endDateInput = document.querySelector('input[name="end_date"]');
        const timeInput = document.querySelector('input[name="time"]');
        const autoRebootModeSelect = document.getElementById('auto-reboot-mode');
        const autoRebootWeekdayWrapper = document.getElementById('auto-reboot-weekday-wrapper');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeValue = document.getElementById('volume-value');
        const scheduleVolumeSlider = document.getElementById('schedule-volume');
        const scheduleVolumeValue = document.getElementById('schedule-volume-value');
        const networkForm = document.getElementById('network-settings-form');
        const networkModeRadios = networkForm ? networkForm.querySelectorAll('input[name="mode"]') : null;
        const manualFieldWrappers = networkForm
            ? networkForm.querySelectorAll('[data-manual-field="ipv4"]')
            : null;
        const manualInputs = networkForm
            ? networkForm.querySelectorAll('input[data-manual-input="ipv4"]')
            : null;
        const manualHint = networkForm ? networkForm.querySelector('[data-manual-hint]') : null;

        function updateItemSelectOptions() {
            if (!itemSelect) {
                return;
            }
            const currentType = typeSelect ? typeSelect.value : itemSelect.dataset.initialType || 'file';
            const items = currentType === 'playlist' ? playlists : audioFiles;
            const hasItems = Array.isArray(items) && items.length > 0;
            const options = Array.from(itemSelect.options || []);
            let firstVisibleOption = null;
            let defaultVisibleOption = null;
            let needsSelectionUpdate = itemSelect.selectedIndex === -1;

            for (const option of options) {
                const optionType = option.dataset ? option.dataset.itemType : undefined;
                const isPlaceholder = option.dataset ? option.dataset.placeholder === 'true' : false;
                const matchesType = !optionType || optionType === currentType;
                option.hidden = !matchesType;
                if (matchesType) {
                    if (isPlaceholder && option.dataset) {
                        option.dataset.default = hasItems ? 'false' : option.dataset.default || 'true';
                    }
                    if (!firstVisibleOption && !option.disabled) {
                        firstVisibleOption = option;
                    }
                    if (!defaultVisibleOption && option.dataset && option.dataset.default === 'true') {
                        defaultVisibleOption = option;
                    }
                }
                if (!matchesType && option.selected) {
                    option.selected = false;
                    needsSelectionUpdate = true;
                }
            }

            if (needsSelectionUpdate || itemSelect.selectedIndex === -1) {
                const fallbackOption = defaultVisibleOption && !defaultVisibleOption.hidden && !defaultVisibleOption.disabled
                    ? defaultVisibleOption
                    : firstVisibleOption;
                if (fallbackOption) {
                    fallbackOption.selected = true;
                }
            }
        }

        function updateDateRangeVisibility() {
            if (!repeatSelect || !dateRangeFields) {
                return;
            }
            const show = repeatSelect.value !== 'once';
            dateRangeFields.classList.toggle('is-hidden', !show);
            if (show && timeInput && startDateInput && !startDateInput.value && timeInput.value) {
                const [datePart] = timeInput.value.split('T');
                if (datePart) {
                    startDateInput.value = datePart;
                }
            }
            if (!show) {
                if (startDateInput) startDateInput.value = '';
                if (endDateInput) endDateInput.value = '';
            }
        }

        function syncStartDateWithTime() {
            if (!timeInput || !startDateInput) {
                return;
            }
            const [datePart] = timeInput.value.split('T');
            if (datePart && !startDateInput.value) {
                startDateInput.value = datePart;
            }
        }

        function updateAutoRebootWeekdayVisibility() {
            if (!autoRebootModeSelect || !autoRebootWeekdayWrapper) {
                return;
            }
            const weekly = autoRebootModeSelect.value === 'weekly';
            autoRebootWeekdayWrapper.classList.toggle('is-hidden', !weekly);
        }

        function getSelectedNetworkMode() {
            if (!networkModeRadios) {
                return 'dhcp';
            }
            for (const radio of networkModeRadios) {
                if (radio instanceof HTMLInputElement && radio.checked) {
                    return radio.value || 'dhcp';
                }
            }
            return 'dhcp';
        }

        function updateManualNetworkVisibility() {
            if (!networkForm) {
                return;
            }
            const mode = getSelectedNetworkMode();
            const manual = mode === 'manual';

            if (manualFieldWrappers) {
                manualFieldWrappers.forEach((element) => {
                    if (element instanceof HTMLElement) {
                        element.classList.toggle('is-hidden', !manual);
                    }
                });
            }

            if (manualInputs) {
                manualInputs.forEach((inputElement) => {
                    if (!(inputElement instanceof HTMLInputElement)) {
                        return;
                    }
                    const mustFill = inputElement.dataset.requiredWhenManual === 'true';
                    inputElement.required = manual && mustFill;
                    if (!manual) {
                        inputElement.setCustomValidity('');
                    }
                });
            }

            if (manualHint && manualHint instanceof HTMLElement) {
                manualHint.classList.toggle('is-hidden', !manual);
            }
        }

        if (typeSelect) {
            typeSelect.addEventListener('change', updateItemSelectOptions);
        }
        if (repeatSelect) {
            repeatSelect.addEventListener('change', updateDateRangeVisibility);
        }
        if (timeInput) {
            timeInput.addEventListener('change', () => {
                syncStartDateWithTime();
                if (
                    endDateInput &&
                    endDateInput.value &&
                    startDateInput &&
                    startDateInput.value &&
                    endDateInput.value < startDateInput.value
                ) {
                    endDateInput.value = startDateInput.value;
                }
            });
        }

        updateItemSelectOptions();
        updateDateRangeVisibility();
        updateAutoRebootWeekdayVisibility();
        if (autoRebootModeSelect) {
            autoRebootModeSelect.addEventListener('change', updateAutoRebootWeekdayVisibility);
        }

        if (networkModeRadios) {
            networkModeRadios.forEach((radio) => {
                radio.addEventListener('change', updateManualNetworkVisibility);
            });
        }
        updateManualNetworkVisibility();

        if (manualInputs) {
            manualInputs.forEach((inputElement) => {
                if (inputElement instanceof HTMLInputElement) {
                    inputElement.addEventListener('input', () => {
                        inputElement.setCustomValidity('');
                    });
                }
            });
        }

        if (networkForm) {
            networkForm.addEventListener('submit', (event) => {
                if (!manualInputs || getSelectedNetworkMode() !== 'manual') {
                    return;
                }
                let firstInvalid = null;
                manualInputs.forEach((inputElement) => {
                    if (!(inputElement instanceof HTMLInputElement)) {
                        return;
                    }
                    const mustFill = inputElement.dataset.requiredWhenManual === 'true';
                    if (!mustFill) {
                        inputElement.setCustomValidity('');
                        return;
                    }
                    const value = inputElement.value.trim();
                    if (!value) {
                        inputElement.setCustomValidity('Dieses Feld ist erforderlich, wenn der Modus „Manuell“ aktiv ist.');
                        if (!firstInvalid) {
                            firstInvalid = inputElement;
                        }
                    } else {
                        inputElement.setCustomValidity('');
                    }
                });

                if (firstInvalid) {
                    event.preventDefault();
                    firstInvalid.reportValidity();
                }
            });
        }

        const confirmForms = document.querySelectorAll('form[data-confirm]');
        confirmForms.forEach((form) => {
            form.addEventListener('submit', (event) => {
                const message = form.getAttribute('data-confirm') || 'Aktion wirklich ausführen?';
                if (!window.confirm(message)) {
                    event.preventDefault();
                }
            });
        });

        if (volumeSlider && volumeValue) {
            const updateVolumeDisplay = () => {
                volumeValue.textContent = `${volumeSlider.value}%`;
            };
            updateVolumeDisplay();
            volumeSlider.addEventListener('input', updateVolumeDisplay);
        }
        if (scheduleVolumeSlider && scheduleVolumeValue) {
            const updateScheduleVolumeDisplay = () => {
                scheduleVolumeValue.textContent = `${scheduleVolumeSlider.value}%`;
            };
            updateScheduleVolumeDisplay();
            scheduleVolumeSlider.addEventListener('input', updateScheduleVolumeDisplay);
        }
    });
    </script>
        </article>
    </section>
</div>

<div class="dashboard-group" id="group-system">
    <h2 class="dashboard-group-title">System &amp; Wartung</h2>
    <section id="auto-reboot" class="dashboard-section dashboard-section--system section-card">
        <article class="dashboard-card stack-md">
            <h3>Automatischer Neustart</h3>
            <form action="{{ url_for('save_auto_reboot_settings') }}" method="POST" class="auto-reboot-form form-card stack-sm max-w-32">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label class="choice-inline">
                    <input type="checkbox" name="auto_reboot_enabled" {% if auto_reboot_settings.enabled %}checked{% endif %}>
                    Automatischer Neustart aktiv
                </label>
                <div class="flex-row flex-wrap gap-lg items-center">
                    <label class="form-field">
                        Uhrzeit
                        <input type="time" name="auto_reboot_time" value="{{ auto_reboot_settings.time }}" required>
                    </label>
                    <label class="form-field">
                        Ausführung
                        <select name="auto_reboot_mode" id="auto-reboot-mode">
                            <option value="daily" {% if auto_reboot_settings.mode == 'daily' %}selected{% endif %}>Täglich</option>
                            <option value="weekly" {% if auto_reboot_settings.mode == 'weekly' %}selected{% endif %}>Wöchentlich</option>
                        </select>
                    </label>
                    <label id="auto-reboot-weekday-wrapper" class="form-field {% if auto_reboot_settings.mode != 'weekly' %}is-hidden{% endif %}">
                        Wochentag
                        <select name="auto_reboot_weekday" id="auto-reboot-weekday">
                            {% for weekday in auto_reboot_weekdays %}
                            <option value="{{ weekday }}" {% if auto_reboot_settings.weekday == weekday %}selected{% endif %}>{{ weekday|capitalize }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>
                <button type="submit" class="btn mt-sm align-self-start">Speichern</button>
            </form>
            <p class="hint">Der automatische Neustart nutzt den System-Scheduler. Bei "Wöchentlich" erfolgt der Neustart nur am gewählten Tag.</p>
        </article>
    </section>

    <section id="system" class="dashboard-section dashboard-section--system section-card">
        <article class="dashboard-card stack-md">
            <h3>System</h3>
            <form action="{{ url_for('update') }}" method="POST" class="stack-sm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn">Update</button>
            </form>
            <div class="inline-actions">
                <form action="{{ url_for('bluetooth_on') }}" method="POST" class="inline-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn">Bluetooth an</button>
                </form>
                <form action="{{ url_for('bluetooth_off') }}" method="POST" class="inline-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn">Bluetooth aus</button>
                </form>
            </div>
            <div class="power-controls action-row mt-lg">
                <form action="{{ url_for('system_reboot') }}" method="POST" data-confirm="System jetzt neu starten?" class="inline-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn">Neustart</button>
                </form>
                <form action="{{ url_for('system_shutdown') }}" method="POST" data-confirm="System wirklich herunterfahren?" class="inline-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn">Herunterfahren</button>
                </form>
            </div>
        </article>
    </section>
</div>

{% endblock %}
