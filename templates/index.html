{% extends 'base.html' %}
{% block title %}Audio Pi Control{% endblock %}
{% block content %}
<h2>Audio Pi Websteuerung</h2>

<section id="status">
    <h3>Status</h3>
    {% if status.get('hifiberry_detected') is sameas false %}
    <div class="warning" style="color:#b30000;font-weight:bold;">
        HiFiBerry DAC nicht erkannt – interner Audio-Ausgang aktiv.
    </div>
    {% endif %}
    <ul>
        <li>Aktuell: {{ 'Wiedergabe läuft' if status['playing'] else 'Wiedergabe gestoppt' }}</li>
        <li>Bluetooth: {{ status['bluetooth_status'] }}</li>
        <li>WLAN: {{ status['wlan_status'] }}</li>
        <li>Endstufe: {{ status['amplifier_status'] }}</li>
        <li>Relais-Umkehr: {{ 'Ja' if status['relay_invert'] else 'Nein' }}</li>
        <li>Lautstärke: {{ status['current_volume'] }}</li>
        <li>Audio-Sink: {{ status['current_sink'] }}</li>
        <li>Time: {{ status['current_time'] }}</li>
        <li>
            RTC:
            {% if status['rtc_available'] %}
                Verfügbar (Adresse {{ '0x%02X'|format(status['rtc_address']) }})
            {% else %}
                Nicht verfügbar
            {% endif %}
        </li>
    </ul>
    {% if not status['rtc_available'] %}
    <div class="alert alert-warning rtc-warning" style="background-color:#fff3cd;padding:1rem;border:1px solid #ffeeba;border-radius:0.5rem;color:#856404;margin-top:1rem;">
        <strong>Warnung:</strong> Keine RTC erkannt. Die Systemzeit läuft ohne Hardware-Uhr weiter; bitte Verkabelung und I²C-Konfiguration prüfen.
    </div>
    {% endif %}
</section>

<section id="auto-reboot">
    <h3>Automatischer Neustart</h3>
    <form action="{{ url_for('save_auto_reboot_settings') }}" method="POST" class="auto-reboot-form">
        <label style="display:block;margin-bottom:0.5rem;">
            <input type="checkbox" name="auto_reboot_enabled" {% if auto_reboot_settings.enabled %}checked{% endif %}>
            Automatischer Neustart aktiv
        </label>
        <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:center;">
            <label>
                Uhrzeit
                <input type="time" name="auto_reboot_time" value="{{ auto_reboot_settings.time }}" required>
            </label>
            <label>
                Ausführung
                <select name="auto_reboot_mode" id="auto-reboot-mode">
                    <option value="daily" {% if auto_reboot_settings.mode == 'daily' %}selected{% endif %}>Täglich</option>
                    <option value="weekly" {% if auto_reboot_settings.mode == 'weekly' %}selected{% endif %}>Wöchentlich</option>
                </select>
            </label>
            <label id="auto-reboot-weekday-wrapper">
                Wochentag
                <select name="auto_reboot_weekday" id="auto-reboot-weekday">
                    {% for weekday in auto_reboot_weekdays %}
                    <option value="{{ weekday }}" {% if auto_reboot_settings.weekday == weekday %}selected{% endif %}>{{ weekday|capitalize }}</option>
                    {% endfor %}
                </select>
            </label>
        </div>
        <button type="submit" class="btn" style="margin-top:0.5rem;">Speichern</button>
    </form>
    <p class="hint">Der automatische Neustart nutzt den System-Scheduler. Bei "Wöchentlich" erfolgt der Neustart nur am gewählten Tag.</p>
</section>

<section id="playback">
    <h3>Playback Steuerung</h3>
    <form action="{{ url_for('set_volume') }}" method="POST" style="display:inline-flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
        {% set raw_volume = status['current_volume'] | default('50', true) %}
        {% set volume_digits = raw_volume | replace('%', '') | replace(' ', '') | trim %}
        {% set volume_initial = volume_digits if volume_digits.isdigit() else '50' %}
        <label class="volume-slider" style="display:flex;align-items:center;gap:0.5rem;">
            <input
                type="range"
                min="0"
                max="100"
                name="volume"
                id="volume-slider"
                value="{{ volume_initial }}"
            >
            <span id="volume-value" style="min-width:3ch;text-align:right;">{{ volume_initial }}%</span>
        </label>
        <button type="submit" class="btn">Setzen</button>
    </form>
    <form action="{{ url_for('activate_amp') }}" method="POST" style="display:inline;">
        <button type="submit" class="btn">Endstufe an</button>
    </form>
    <form action="{{ url_for('deactivate_amp') }}" method="POST" style="display:inline;">
        <button type="submit" class="btn">Endstufe aus</button>
    </form>
    <form action="{{ url_for('set_relay_invert') }}" method="POST" style="display:inline;">
        <label>
            <input type="checkbox" name="invert" value="1" {% if status['relay_invert'] %}checked{% endif %}>
            Relay umkehren
        </label>
        <button type="submit" class="btn">Speichern</button>
    </form>
    <form action="{{ url_for('toggle_pause') }}" method="POST" style="display:inline;">
        <button type="submit" class="btn">Pause/Resume</button>
    </form>
    <form action="{{ url_for('stop_playback') }}" method="POST" style="display:inline;">
        <button type="submit" class="btn">Stopp</button>
    </form>
</section>

<section id="files">
    <h3>Datei-Upload</h3>
    <form action="{{ url_for('upload') }}" method="POST" enctype="multipart/form-data">
        <input type="file" name="file" required>
        <button type="submit" class="btn">Upload</button>
    </form>

    <h3>Audio-Dateien</h3>
    <ul>
        {% for file in files %}
        <li>
            {{ file.filename }}
            {% if file.duration_seconds is not none %}
                ({{ '%.2f' % file.duration_seconds }}&nbsp;s)
            {% else %}
                (Dauer unbekannt)
            {% endif %}
            <a href="{{ url_for('play_now', item_type='file', item_id=file.id) }}">Play</a>
            <form action="{{ url_for('delete', file_id=file.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn">Löschen</button>
            </form>
        </li>
        {% endfor %}
    </ul>
</section>

<section id="playlists">
    <h3>Playlists</h3>
    <form action="{{ url_for('create_playlist') }}" method="POST">
        <input type="text" name="name" placeholder="Playlist-Name" required>
        <button type="submit" class="btn">Erstellen</button>
    </form>
    <ul>
        {% for playlist in playlists %}
        <li>
            {{ playlist.name }}
            <a href="{{ url_for('play_now', item_type='playlist', item_id=playlist.id) }}">Play</a>
            <form action="{{ url_for('delete_playlist', playlist_id=playlist.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn">Löschen</button>
            </form>
            <form action="{{ url_for('add_to_playlist') }}" method="POST" style="display:inline;">
                <select name="file_id">
                    {% for file in files %}
                    <option value="{{ file.id }}">{{ file.filename }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="playlist_id" value="{{ playlist.id }}">
                <button type="submit" class="btn">Hinzufügen</button>
            </form>
        </li>
        {% endfor %}
    </ul>
</section>

<section id="schedules">
    <h3>Zeitpläne</h3>
    <form action="{{ url_for('add_schedule') }}" method="POST">
        <select name="item_type" id="item-type">
            <option value="file">Datei</option>
            <option value="playlist">Playlist</option>
        </select>
        <select name="item_id" id="item-select"></select>
        <input type="datetime-local" name="time" required>
        <select name="repeat" id="repeat-select">
            <option value="daily">Täglich</option>
            <option value="monthly">Monatlich</option>
            <option value="once">Nur einmal</option>
        </select>
        <div id="date-range-fields" style="display:none;">
            <label>
                Startdatum
                <input type="date" name="start_date">
            </label>
            <label>
                Enddatum (optional)
                <input type="date" name="end_date">
            </label>
        </div>
        <label class="schedule-volume" style="display:inline-flex;align-items:center;gap:0.5rem;margin-top:0.5rem;">
            Lautstärke
            <input
                type="range"
                name="volume_percent"
                id="schedule-volume"
                min="0"
                max="100"
                value="100"
            >
            <span id="schedule-volume-value" style="min-width:3ch;text-align:right;">100%</span>
        </label>
        <input type="number" name="delay" value="5" min="0" max="60" style="width:50px;"> Sek. Verzögerung
        <button type="submit" class="btn">Hinzufügen</button>
    </form>
    <p class="hint">
        Hinweis: Überlappende Zeitpläne werden automatisch verhindert. Bei einem Konflikt erscheint eine Fehlermeldung.
    </p>
    <ul>
        {% for schedule in schedules %}
        <li>
            {{ schedule.name or 'Unbekanntes Element' }} ({{ schedule.item_type }}) - {{ schedule.time }} ({{ schedule.repeat }}) +{{ schedule.delay }}s
            – Lautstärke {{ schedule.volume_percent }}%
            {% if schedule.start_date or schedule.end_date %}
                [
                {{ schedule.start_date or 'ab sofort' }}{% if schedule.end_date %} – {{ schedule.end_date }}{% endif %}
                ]
            {% endif %}
            {% if schedule.executed and schedule.repeat == 'once' %}- ausgeführt{% endif %}
            <form action="{{ url_for('delete_schedule', sch_id=schedule.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn">Entfernen</button>
            </form>
        </li>
        {% endfor %}
    </ul>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const audioFiles = {{ files | tojson }};
        const playlists = {{ playlists | tojson }};
        const itemSelect = document.getElementById('item-select');
        const typeSelect = document.getElementById('item-type');
        const repeatSelect = document.getElementById('repeat-select');
        const dateRangeFields = document.getElementById('date-range-fields');
        const startDateInput = document.querySelector('input[name="start_date"]');
        const endDateInput = document.querySelector('input[name="end_date"]');
        const timeInput = document.querySelector('input[name="time"]');
        const autoRebootModeSelect = document.getElementById('auto-reboot-mode');
        const autoRebootWeekdayWrapper = document.getElementById('auto-reboot-weekday-wrapper');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeValue = document.getElementById('volume-value');
        const scheduleVolumeSlider = document.getElementById('schedule-volume');
        const scheduleVolumeValue = document.getElementById('schedule-volume-value');

        function populate() {
            if (!itemSelect || !typeSelect) {
                return;
            }
            const items = typeSelect.value === 'playlist' ? playlists : audioFiles;
            const label = typeSelect.value === 'playlist' ? 'Playlist' : 'Datei';
            itemSelect.innerHTML = `<option value="">-- ${label} wählen --</option>`;
            for (const item of items) {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = item.name || item.filename;
                itemSelect.appendChild(opt);
            }
        }

        function updateDateRangeVisibility() {
            if (!repeatSelect || !dateRangeFields) {
                return;
            }
            const show = repeatSelect.value !== 'once';
            dateRangeFields.style.display = show ? 'block' : 'none';
            if (show && timeInput && startDateInput && !startDateInput.value && timeInput.value) {
                const [datePart] = timeInput.value.split('T');
                if (datePart) {
                    startDateInput.value = datePart;
                }
            }
            if (!show) {
                if (startDateInput) startDateInput.value = '';
                if (endDateInput) endDateInput.value = '';
            }
        }

        function syncStartDateWithTime() {
            if (!timeInput || !startDateInput) {
                return;
            }
            const [datePart] = timeInput.value.split('T');
            if (datePart && !startDateInput.value) {
                startDateInput.value = datePart;
            }
        }

        function updateAutoRebootWeekdayVisibility() {
            if (!autoRebootModeSelect || !autoRebootWeekdayWrapper) {
                return;
            }
            autoRebootWeekdayWrapper.style.display = autoRebootModeSelect.value === 'weekly' ? 'block' : 'none';
        }

        if (typeSelect) {
            typeSelect.addEventListener('change', populate);
        }
        if (repeatSelect) {
            repeatSelect.addEventListener('change', updateDateRangeVisibility);
        }
        if (timeInput) {
            timeInput.addEventListener('change', () => {
                syncStartDateWithTime();
                if (
                    endDateInput &&
                    endDateInput.value &&
                    startDateInput &&
                    startDateInput.value &&
                    endDateInput.value < startDateInput.value
                ) {
                    endDateInput.value = startDateInput.value;
                }
            });
        }

        populate();
        updateDateRangeVisibility();
        updateAutoRebootWeekdayVisibility();
        if (autoRebootModeSelect) {
            autoRebootModeSelect.addEventListener('change', updateAutoRebootWeekdayVisibility);
        }

        const confirmForms = document.querySelectorAll('form[data-confirm]');
        confirmForms.forEach((form) => {
            form.addEventListener('submit', (event) => {
                const message = form.getAttribute('data-confirm') || 'Aktion wirklich ausführen?';
                if (!window.confirm(message)) {
                    event.preventDefault();
                }
            });
        });

        if (volumeSlider && volumeValue) {
            const updateVolumeDisplay = () => {
                volumeValue.textContent = `${volumeSlider.value}%`;
            };
            updateVolumeDisplay();
            volumeSlider.addEventListener('input', updateVolumeDisplay);
        }
        if (scheduleVolumeSlider && scheduleVolumeValue) {
            const updateScheduleVolumeDisplay = () => {
                scheduleVolumeValue.textContent = `${scheduleVolumeSlider.value}%`;
            };
            updateScheduleVolumeDisplay();
            scheduleVolumeSlider.addEventListener('input', updateScheduleVolumeDisplay);
        }
    });
    </script>
</section>

<section id="system">
    <h3>System</h3>
    <form action="{{ url_for('update') }}" method="POST">
        <button type="submit" class="btn">Update</button>
    </form>
    <form action="{{ url_for('bluetooth_on') }}" method="POST" style="display:inline;">
        <button type="submit" class="btn">Bluetooth an</button>
    </form>
    <form action="{{ url_for('bluetooth_off') }}" method="POST" style="display:inline;">
        <button type="submit" class="btn">Bluetooth aus</button>
    </form>
    <div class="power-controls" style="margin-top:1rem;">
        <form action="{{ url_for('system_reboot') }}" method="POST" data-confirm="System jetzt neu starten?" style="display:inline;">
            <button type="submit" class="btn">Neustart</button>
        </form>
        <form action="{{ url_for('system_shutdown') }}" method="POST" data-confirm="System wirklich herunterfahren?" style="display:inline;">
            <button type="submit" class="btn">Herunterfahren</button>
        </form>
    </div>
</section>

{% endblock %}
